  <!DOCTYPE html>
<html lang="en">

<head>
  <script>
    const searchParams = new URL(window.location).searchParams
    const config = {
      // ensure that this file is located at root level of S3 bucket
      bucketUrl: searchParams.get('bucket') || window.location.href.split(/[?#]/)[0].replace(/\/[^\/]+$/, ''),
      keyExcludePattern: /^index\.html$/,
      pageSize: 50,
      
      title: 'AWS S3 Bucket Browser',
      subtitle: 'made with â™¥ by qoomon',
      logo: 'logo.png',
      favicon: 'favicon.ico'
    }
  </script>
  
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link id="favicon" rel="shortcut icon"/>
  <script src="https://unpkg.com/vue@2.6.10"></script><script>Vue.config.productionTip = false;</script>
  <script src="https://unpkg.com/buefy@0.8.6/dist/buefy.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/buefy@0.8.6/dist/buefy.min.css">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css">
  <link rel="stylesheet" href="https://cdn.materialdesignicons.com/2.5.94/css/materialdesignicons.min.css">
  <script src="https://unpkg.com/moment@2.14.1/min/moment.min.js"></script>
</head>

<body class="notification" style="width: 100vw; min-height: 100vh;">
  
  <a href="https://github.com/qoomon/aws-s3-bucket-browser" style="position: absolute; top: 0; right: 0;"><img width="149" height="149" src="https://github.blog/wp-content/uploads/2008/12/forkme_right_red_aa0000.png?resize=149%2C149" data-recalc-dims="1"></a>
  
  <div id="app" class="section">
  
    <div class="container">
      <div class="level">
        <div class="level-left">
          <figure class="level-item image is-128x128" style="margin-right: 1.5rem;">
            <img :src="config.logo"/>
          </figure>
          <div>
            <h1 class="title">{{config.title}}</h1>
            <h2 class="subtitle">{{config.subtitle}}</h2>
          </div>
        </div>
      </div>
    
      <div class="container is-clearfix">
        <div class="buttons is-pulled-left">
          <b-button v-for="(breadcrump, index) in pathBreadcrumps" v-bind:key="breadcrump.url" 
            type="is-info" rounded
            tag="a" 
            :href="breadcrump.url" 
            icon-pack="fas"
            :icon-left="index == 0 ? 'folder' : ''"
            target=""
            :style="{ fontWeight: index == 0 ? 'bolder': '' }"
            >
            <template v-if="index == 0">/</template>
            <template v-else="index > 0">{{breadcrump.name}}</template>
          </b-button>
        </div>
        <div v-show="nextContinuationToken || previousContinuationTokens.length > 0"
          class="buttons is-pulled-right">
          <b-button
            type="is-info" rounded
            icon-pack="fas"
            icon-left="angle-left"
            @click="previousPage"
            :disabled="previousContinuationTokens.length === 0"
            >
          </b-button>
          <b-button
            type="is-info" rounded
            icon-pack="fas"
            icon-right="angle-right"
            @click="nextPage"
            :disabled="!nextContinuationToken"
            >
          </b-button>
        </div>
      </div>

      <b-table :data="pathContentTableData" :hoverable="true">
        <template slot-scope="props">
          <b-table-column 
            field="type" sortable
            label="Type" 
            centered  width="1"
            >
            <b-icon pack="far" :icon="props.row.type === 'prefix' ? 'folder' : 'file-alt'"></b-icon>
          </b-table-column>
          <b-table-column 
            field="name" sortable
            label="Name"
            >
            <b-button 
              type="is-info is-text" inverted rounded 
              tag="a" 
              :href="props.row.type === 'content' ? props.row.url : `#/${props.row.prefix}`" 
              :download="props.row.type === 'content' ? props.row.name :  false"
              >
              {{ props.row.name }}
            </b-button>
          </b-table-column>
          <b-table-column 
            field="size" numeric sortable
            label="Size"
            >
            {{ props.row.size | formatBytes}}
          </b-table-column>
          <b-table-column 
              field="lastModified" sortable
              label="Last Modified"
              centered 
              >
              <template v-if="props.row.lastModified">
                <b-tooltip 
                  type="is-info" 
                  position="is-left" 
                  animated
                  :label="moment(props.row.lastModified).format('hh:mm:ss - dddd, MMMM Do, YYYY')"
                  >
                  {{ moment(props.row.lastModified).fromNow() }}
                </b-tooltip>
              </template>
              <template v-else>
                -
              </template>
          </b-table-column>
        </template>
      </b-table>

      <div class="container is-clearfix" style="margin-top: 1rem;">
        <div v-show="nextContinuationToken || previousContinuationTokens.length > 0"
          class="buttons is-pulled-right">
          <b-button
            type="is-info" rounded
            icon-pack="fas"
            icon-left="angle-left"
            @click="previousPage"
            :disabled="previousContinuationTokens.length === 0"
            >
          </b-button>
          <b-button
            type="is-info" rounded
            icon-pack="fas"
            icon-right="angle-right"
            @click="nextPage"
            :disabled="!nextContinuationToken"
            >
          </b-button>
        </div>
      </div>
    </div>    
  </div>
  
  <script>
    document.title = config.title;
    document.getElementById('favicon').href = config.favicon;

    Vue.use(Buefy.default, {
    	defaultIconPack: 'fa'
    });
    
    new Vue({
      el: '#app',
      data: {
        config, // defined in <head> section
        hashUrl: new URL('/', location),
        
        pathContentTableData: [],
        
        previousContinuationTokens: [],
        continuationToken: undefined,
        nextContinuationToken: undefined
      },
      computed: {
        pathBreadcrumps() {
          return this.hashUrl.pathname.match(/(?=[/])|[^/]+[/]?/g)
            .map((pathPrefixPart, index, pathPrefixParts) => ({
              name: pathPrefixPart,
              url: '#/' + pathPrefixParts.slice(0, index).join('') + pathPrefixPart
            }));
        }
      },
      watch: {
        hashUrl() {
          this.previousContinuationTokens = [];
          this.continuationToken = undefined;
          this.nextContinuationToken = undefined;
          this.refresh();
        }
      },
      methods: {
        moment: moment,
        previousPage(){
          if(this.previousContinuationTokens.length > 0){
            this.continuationToken = this.previousContinuationTokens.pop();
            this.refresh();
          }
        },
        nextPage(){
          if(this.nextContinuationToken){
            this.previousContinuationTokens.push(this.continuationToken);
            this.continuationToken = this.nextContinuationToken;
            this.refresh();
          }
        },
        async refresh() {
          let listBucketResult;
          try {
            let bucketListApiUrl = `${this.config.bucketUrl}?list-type=2`;
            bucketListApiUrl += `&delimiter=/`;
            let pathPrefix = this.hashUrl.pathname.replace(/^\//,'');
            bucketListApiUrl += `&prefix=${pathPrefix}`;
            
            if(this.config.pageSize){
              bucketListApiUrl += `&max-keys=${this.config.pageSize}`;
            }
            if(this.continuationToken){
              bucketListApiUrl += `&continuation-token=${encodeURIComponent(this.continuationToken)}`;
            }
            let listBucketResultResponse = await fetch(bucketListApiUrl);
            let listBucketResultXml = await listBucketResultResponse.text();
            
            listBucketResult = new DOMParser().parseFromString(listBucketResultXml, "text/xml");
            if (!listBucketResult.querySelector('ListBucketResult')){
              throw Error("List bucket response does not contain <ListBucketResult> tag!");
            }
          } catch (error) {
            this.$buefy.notification.open({
                    message: escapeHTML(error.message),
                    type: 'is-danger',
                    duration: 60000,
                    position: 'is-bottom'
                });
            throw error;
          }
          let nextContinuationTokenTag = listBucketResult.querySelector("NextContinuationToken");
          this.nextContinuationToken =  nextContinuationTokenTag && nextContinuationTokenTag.textContent;
          let commonPrefixes = [...listBucketResult.querySelectorAll("ListBucketResult > CommonPrefixes")].map(tag => ({
            prefix: tag.querySelector('Prefix').textContent
          }));
          let contents = [...listBucketResult.querySelectorAll("ListBucketResult > Contents")].map(tag => ({
            key: tag.querySelector('Key').textContent,
            size: parseInt(tag.querySelector('Size').textContent),
            lastModified: new Date(tag.querySelector('LastModified').textContent)
          }));

          this.pathContentTableData = [];
          commonPrefixes
            .forEach(prefix => {
              this.pathContentTableData.push({
                type: 'prefix',
                name: prefix.prefix.replace(/^.*\/(?=.+)/, ''),
                
                prefix: prefix.prefix
              })
            });
          contents
            .filter(content => !content.key.endsWith('/')) // exclude folder entries
            .filter(content => !config.keyExcludePattern || !content.key.match(config.keyExcludePattern))
            .forEach(content => {
              this.pathContentTableData.push({
                type: 'content',
                name: content.key.replace(/^.*\//, ''),
                size: content.size,
                lastModified: content.lastModified,

                key: content.key,
                url: `${this.config.bucketUrl}/${content.key}`
              })
            });
        }
      },
      async mounted() {
        window.onhashchange = () => {
          let locationHash = window.location.hash.replace(/^#/, '');
          let normalizedLocationHash = `/${locationHash.replace(/^\/+/, '')}`;
          if(locationHash === normalizedLocationHash){
            this.hashUrl = new URL(normalizedLocationHash, location);
          } else {
            window.location.hash = normalizedLocationHash;
          }
        }
        window.onhashchange();
      },
      filters: {
        formatBytes(size) {
          if(!size){
            return '-'
          }
          const KB = 1024;
          if (size < KB) {
              return size + '  B';
          }
          const MB = 1000000;
          if (size < MB) {
              return (size / KB).toFixed(0) + ' KB';
          } 
          const GB = 1000000000;
          if (size < GB) {
              return (size / MB).toFixed(2) + ' MB';
          }
          return (size / GB).toFixed(2) + ' GB';
        },
        formatDate(date) {
          if(!date){
            return '-'
          }
          return `${date.toLocaleDateString()} ${date.toLocaleTimeString()}`
        }
      }
    });
    
    function escapeHTML(unsafeText) {
        let div = document.createElement('div');
        div.innerText = unsafeText;
        return div.innerHTML;
    }
  </script>
  
  <style>
    .button.is-text {
      height: auto;
      user-select: text;
      box-shadow: none;
      white-space: unset;
      background: none;
      background-color: transparent !important;
      text-decoration: none;
      padding: 0;
    }
  </style>

</body>

</html>
